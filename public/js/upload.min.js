class VideoUploader{constructor(){this.form=document.querySelector(".frame-upload"),this.dropArea=this.form.querySelector(".frame-upload--file-drop"),this.fileInput=this.dropArea.querySelector("input"),this.preview=this.form.querySelector(".frame-upload--file-preview"),this.video=this.preview.querySelector("video"),this.fileInfo=this.form.querySelector(".frame-upload--file-info"),this.progressIndicator=this.form.querySelector(".frame-upload--progress-indicator"),this.progressLabel=this.form.querySelector(".frame-upload--progress-label"),this.progressMessage=this.form.querySelector(".frame-upload--progress-message"),this.errorMsg=this.form.querySelector(".frame-upload--error-message"),this.isUploading=!1,this.errorTimeout=null,this.initEventListener()}initEventListener(){this.fileInput.addEventListener("change",this.handleFileSelect.bind(this)),this.preview.querySelector(".change-file").addEventListener("click",this.clearFileSelect.bind(this)),this.form.addEventListener("submit",this.submit.bind(this)),this.form.addEventListener("reset",this.reset.bind(this)),window.addEventListener("beforeunload",(e=>{this.isUploading&&e.preventDefault()}))}handleFileSelect(e){const t=e.target.files[0];t&&t.type.startsWith("video/")&&(this.video.src=URL.createObjectURL(t),this.video.load(),this.dropArea.classList.add("hidden"),this.preview.classList.remove("hidden"),this.fileInfo.querySelector(".name").textContent=t.name,this.fileInfo.querySelector(".size").textContent=formatFileSize(t.size),this.fileInfo.querySelector(".type").textContent=t.type,this.video.addEventListener("loadedmetadata",(()=>{this.fileInfo.querySelector(".duration").textContent=formatTime(this.video.duration),this.fileInfo.querySelector(".resolution").textContent=`${this.video.videoWidth}px × ${this.video.videoHeight}px`})))}clearFileSelect(){this.fileInput.value="",this.video.src="",this.video.load(),this.dropArea.classList.remove("hidden"),this.preview.classList.add("hidden"),this.fileInfo.querySelectorAll("strong").forEach((e=>e.textContent="—"))}showError(e){this.form.classList.remove("processing"),this.form.classList.add("error"),this.errorMsg.textContent=e,clearTimeout(this.errorTimeout),this.errorTimeout=setTimeout((()=>{this.form.classList.remove("processing","error"),this.isUploading=!1}),2500)}setStatus(e,t=null){this.progressIndicator.style.setProperty("--progress",e||0),this.progressLabel.textContent=Math.round(e||0)+"%",t&&(this.progressMessage.textContent=t)}handleServerLine(e){if(!e||"object"!=typeof e)return;const t=e.msg||"",s="number"==typeof e.progress?Math.min(100,Math.max(0,e.progress)):0;!1===e.success?this.showError(t):this.setStatus(s,t),"done"===e.phase&&e.videoId&&setTimeout((()=>location.href=`/watch/${e.videoId}`),800)}async submit(e){if(e.preventDefault(),this.isUploading)return;this.isUploading=!0,this.form.classList.add("processing");const t=new FormData(this.form);let s=0;const r=new XMLHttpRequest;r.open("POST","/api/upload",!0),r.upload.onprogress=e=>{e.lengthComputable&&this.setStatus(Math.round(e.loaded/e.total*50))},r.onprogress=()=>{const e=r.responseText||"",t=e.substring(s).split("\n");s=e.length;for(const e of t)if(e.trim())try{this.handleServerLine(JSON.parse(e))}catch{}},r.onload=()=>{if(this.isUploading=!1,r.status>=200&&r.status<300){const e=(r.responseText||"").split("\n");for(const t of e)if(t.trim())try{this.handleServerLine(JSON.parse(t))}catch{}}else this.showError("Error: "+r.status)},r.onerror=()=>{this.isUploading=!1,this.showError("Network Error")},r.send(t)}reset(){this.clearFileSelect()}}document.addEventListener("DOMContentLoaded",(()=>new VideoUploader));