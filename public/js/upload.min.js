class VideoUploader{constructor(){this.container=document.querySelector(".upload-container"),this.dropArea=this.container.querySelector(".file-drop-area"),this.fileInput=this.container.querySelector('[name="video"]'),this.preview=this.container.querySelector(".video-preview"),this.previewPlayer=this.preview.querySelector(".preview-player"),this.error=this.container.querySelector(".upload-error"),this.progress=this.container.querySelector(".upload-progress"),this.spinner=this.container.querySelector(".loading-spinner"),this.initEventHandlers()}initEventHandlers(){["dragenter","dragover","dragleave","drop"].forEach((e=>{this.dropArea.addEventListener(e,(e=>e.preventDefault()&&e.stopPropagation()))})),["dragenter","dragover"].forEach((e=>{this.dropArea.addEventListener(e,(()=>this.dropArea.classList.add("dragover")))})),["dragleave","drop"].forEach((e=>{this.dropArea.addEventListener(e,(()=>this.dropArea.classList.remove("dragover")))})),this.dropArea.addEventListener("drop",(e=>this.handleFileSelect(e.dataTransfer.files[0]))),this.fileInput.addEventListener("change",(e=>this.handleFileSelect(e.target.files[0]))),this.container.querySelector(".change-video").addEventListener("click",(()=>location.reload())),this.container.addEventListener("submit",(e=>{e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),this.handleUpload()}))}handleFileSelect(e){if(!e||!e.type.startsWith("video/"))return void this.showError("Wrong file type! Video formats only.");const t=this.preview.querySelector(".file-info");t.querySelector(".name").textContent=e.name,t.querySelector(".size").textContent=formatFileSize(e.size);const r=URL.createObjectURL(e);this.previewPlayer.src=r,this.previewPlayer.load(),this.dropArea.classList.add("hidden"),this.preview.classList.remove("hidden"),this.error.classList.add("hidden")}showError(e){this.error.classList.remove("hidden"),this.error.querySelector(".message").textContent=e}handleServerLine(e){if(!e||"object"!=typeof e)return;const t=e.message||"",r="number"==typeof e.progress?Math.min(100,Math.max(0,e.progress)):null;null!==r&&(this.progress.style.setProperty("--progress",r+"%"),this.progress.querySelector(".status-text .right").textContent=Math.round(r)+"%"),t&&(this.progress.querySelector(".status-text .left").textContent=t),"done"===e.phase&&e.videoId&&setTimeout((()=>location.href=`/watch/${e.videoId}`),400)}async handleUpload(){const e=new FormData(this.container);let t=0;this.container.classList.add("processing"),this.error.classList.add("hidden"),this.progress.classList.remove("hidden"),this.spinner.classList.remove("hidden");const r=new XMLHttpRequest;r.open("POST","/api/upload",!0),r.upload.onprogress=e=>{if(e.lengthComputable){const t=Math.round(e.loaded/e.total*50);this.progress.style.setProperty("--progress",t+"%"),this.progress.querySelector(".status-text .left").textContent="Uploading",this.progress.querySelector(".status-text .right").textContent=t+"%"}},r.onprogress=()=>{const e=r.responseText||"",s=e.substring(t).split("\n");t=e.length;for(const e of s)if(e.trim())try{this.handleServerLine(JSON.parse(e))}catch(e){}},r.onload=()=>{if(r.status>=200&&r.status<300){const e=(r.responseText||"").split("\n");for(const t of e)if(t.trim())try{this.handleServerLine(JSON.parse(t))}catch(e){}}else this.showError("Upload failed: "+r.status)},r.onerror=()=>this.showError("Network error during upload"),r.send(e)}}document.addEventListener("DOMContentLoaded",(()=>new VideoUploader));