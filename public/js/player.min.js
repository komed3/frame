class VideoPlayer{constructor(){this.player=document.querySelector(".player"),this.container=this.player.querySelector(".player-container"),this.video=this.player.querySelector("video"),this.controls=this.player.querySelector(".player-controls"),this.actions=this.initActions(),this.videoId=this.player.getAttribute("videoId"),this.videoDir="/media/"+this.videoId+"/",this.videoData={},this.loaded=!1,this.ready=!1,this.initEventHandlers(),this.loadMeta().then((()=>{this.loadState(),this.saveState(),this.initVideo(),this.loadWaveform()}))}initActions(){const e={};return this.controls.querySelectorAll("[action]").forEach((t=>{e[t.getAttribute("action")]=t})),e}initEventHandlers(){}async loadMeta(){if(!this.loaded)try{const e=await fetch("/api/video/"+this.videoId,{method:"post",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error("Error fetching video data");this.videoData=await e.json(),this.loaded=!0}catch(e){throw new Error(e)}}loadState(){this.playerState=JSON.parse(localStorage.getItem("__player__")??'{ "volume": 1, "playbackRate": 1 }'),this.videoState=JSON.parse(localStorage.getItem(this.videoId)??'{ "progress": 0 }')}saveState(){localStorage.setItem("__player__",JSON.stringify(this.playerState)),localStorage.setItem(this.videoId,JSON.stringify(this.videoState))}async stream(){if(this.ready)return;const e=524288,t=(await fetch(this.videoDir+this.videoData.fileName)).body.getReader(),i=new ReadableStream({async pull(i){let{done:a,value:s}=await t.read();if(a)return i.close();for(let t=0;t<s.length;t+=e)i.enqueue(s.slice(t,t+e))}}),a=await new Response(i).blob(),s=URL.createObjectURL(a);this.video.src=s}async initVideo(){this.ready||(this.loaded||await this.loadMeta(),await this.stream(),this.video.poster=this.videoDir+"poster.jpg",this.video.load(),this.ready=!0,this.hideLoad())}async loadWaveform(){this.loaded||await this.loadMeta();const e=this.controls.querySelector(".waveform"),t=e.getContext("2d",{alpha:!0}),i=this.videoData.waveform||[];let a,s=[];const o=(e,i)=>{const{h:s,barWidth:o}=a,l=i*o,r=s-e/100*s;t.fillRect(l,r,.8*o,e/100*s)},l=()=>{const t=window.devicePixelRatio||1,o=e.clientWidth*t,l=e.clientHeight*t;e.width===o&&e.height===l||(e.width=o,e.height=l);const n=Math.min(i.length,Math.floor(o/3)),c=i.length/n;s=Array.from({length:n},((e,t)=>Math.max(...i.slice(Math.floor(t*c),Math.floor((t+1)*c))))),a={w:o,h:l,barWidth:o/s.length},r()},r=()=>{const{w:e,h:i}=a,l=this.video.currentTime/this.video.duration,r=Math.floor(s.length*l);t.clearRect(0,0,e,i),t.fillStyle="rgba( 255 255 255 / 0.2 )",s.forEach(o),t.fillStyle="rgba( 224 47 47 / 0.6 )",s.slice(0,r).forEach(o)};new ResizeObserver(l).observe(e),this.video.addEventListener("timeupdate",r),l()}showLoad(){this.player.classList.add("load")}hideLoad(){this.player.classList.remove("load")}setActionState(e,t={}){const{add:i=[],rmv:a=[],tgl:s=[]}=t;this.player.classList.add(i),this.player.classList.remove(a),this.player.classList.toggle(s);for(const[t,i]of Object.entries(e))this.actions[t].disabled=!i}isFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)}async maximize(){this.isFullscreen()||(this.container.requestFullscreen?await this.container.requestFullscreen():this.container.webkitRequestFullscreen?await this.container.webkitRequestFullscreen():this.container.mozRequestFullScreen&&await this.container.mozRequestFullScreen())}async minimize(){this.isFullscreen()&&(document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.mozCancelFullScreen&&await document.mozCancelFullScreen())}async toggleFullscreen(){this.isFullscreen()?await this.minimize():await this.maximize()}updateFullscreenState(){const e=this.isFullscreen();this.setActionState({maximize:!e,minimize:e},{add:e?"fullscreen":"",rmv:e?"":"fullscreen"})}}document.addEventListener("DOMContentLoaded",(()=>new VideoPlayer));