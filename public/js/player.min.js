class VideoPlayer{bindings=["f","j","k","l","m"," ",",",".","+","-","0","1","2","3","4","5","6","7","8","9","ArrowUp","ArrowLeft","ArrowRight","ArrowDown","Home","End","Escape","F6","F7","F8","F9","F11"];constructor(){this.player=document.querySelector(".player"),this.container=this.player.querySelector(".player-container"),this.video=this.player.querySelector("video"),this.controls=this.player.querySelector(".player-controls"),this.timecode=this.controls.querySelector(".timecode"),this.actions=this.initActions(),this.setActionState({pause:!1,replay:!1,prev:!1,next:!1,minimize:!1,unmute:!1}),this.overlay={icon:this.player.querySelector(".player-overlay .icon"),msg:this.player.querySelector(".player-overlay .msg")},this.videoId=this.player.getAttribute("videoId"),this.videoDir=`/media/${this.videoId}/`,this.videoData={},this.loaded=!1,this.ready=!1,this.seekDirection=!0,this.previousVolume=0,this.controlsTimeout=null,this.overlayTimeout=null,this.initEventHandlers(),this.initKeyBindings(),this.loadData().then((()=>{this.loadState(),this.saveState(),this.getInfo(),this.initSeekbar(),this.loadWaveform(),this.initVideo()}))}initActions(){const e={};return this.controls.querySelectorAll("[action]").forEach((t=>{e[t.getAttribute("action")]=t})),e}initEventHandlers(){this.container.addEventListener("mousemove",this.showControls.bind(this)),this.container.addEventListener("mouseleave",this.hideControls.bind(this)),this.actions.interact.addEventListener("click",this.togglePlay.bind(this)),this.actions.play.addEventListener("click",this.play.bind(this)),this.actions.pause.addEventListener("click",this.pause.bind(this)),this.actions.replay.addEventListener("click",this.play.bind(this)),this.container.addEventListener("wheel",this.handleScroll.bind(this)),this.actions.mute.addEventListener("click",this.mute.bind(this)),this.actions.unmute.addEventListener("click",this.unmute.bind(this)),this.actions.volume.addEventListener("input",(e=>{this.setVolume(e.target.value),setTimeout((()=>e.target.blur()),10)})),this.actions.pbr.addEventListener("click",(e=>this.setPlaybackRate(e.target.getAttribute("rate")))),this.actions.rewind.addEventListener("click",(()=>this.skip(-5))),this.actions.fastForward.addEventListener("click",(()=>this.skip(5))),this.actions.interact.addEventListener("click",this.hideSettings.bind(this)),this.actions.download.addEventListener("click",this.download.bind(this)),this.actions.settings.addEventListener("click",this.toggleSettings.bind(this)),this.actions.info.addEventListener("click",this.toggleInfo.bind(this)),document.addEventListener("fullscreenchange",this.updateFullscreenState.bind(this)),this.container.addEventListener("dblclick",this.toggleFullscreen.bind(this)),this.actions.maximize.addEventListener("click",this.maximize.bind(this)),this.actions.minimize.addEventListener("click",this.minimize.bind(this)),this.video.addEventListener("waiting",this.showLoad.bind(this)),this.video.addEventListener("canplay",this.hideLoad.bind(this)),this.video.addEventListener("playing",this.hideLoad.bind(this)),this.video.addEventListener("play",this.updatePlayState.bind(this)),this.video.addEventListener("play",this.hideControls.bind(this)),this.video.addEventListener("pause",this.updatePlayState.bind(this)),this.video.addEventListener("pause",this.showControls.bind(this)),this.video.addEventListener("ended",this.updatePlayState.bind(this)),this.video.addEventListener("ended",this.showControls.bind(this)),this.video.addEventListener("volumechange",this.updateVolumeState.bind(this)),this.video.addEventListener("ratechange",this.updatePlaybackRateState.bind(this)),this.video.addEventListener("timeupdate",this.updateProgress.bind(this)),this.video.addEventListener("loadedmetadata",this.updateTimeDisplay.bind(this)),this.video.addEventListener("progress",this.updateBuffer.bind(this))}initKeyBindings(){document.addEventListener("keydown",(e=>{if("INPUT"!==e.target.tagName&&this.bindings.includes(e.key))switch(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),e.key){case" ":case"k":case"F7":this.togglePlay(),this.playOverlay();break;case"m":case"F9":this.toggleMute(),this.volumeOverlay();break;case"ArrowUp":this.changeVolume(.1),this.volumeOverlay();break;case"ArrowDown":this.changeVolume(-.1),this.volumeOverlay();break;case"ArrowLeft":case"j":case"F6":this.skip(-5),this.seekOverlay();break;case"ArrowRight":case"l":case"F8":this.skip(5),this.seekOverlay();break;case"Home":this.begin(),this.seekOverlay();break;case"End":this.end(),this.seekOverlay();break;case",":this.skipFrame(-1);break;case".":this.skipFrame(1);break;case"+":this.changePlaybackRate(.25),this.playbackRateOverlay();break;case"-":this.changePlaybackRate(-.25),this.playbackRateOverlay();break;case"F11":case"f":this.toggleFullscreen();break;case"Escape":this.minimize();break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":this.seek(10*Number(e.key)),this.seekOverlay();break}}))}initSeekbar(){const e=this.controls.querySelector(".progress"),t=e.querySelector(".hover"),i=e.querySelector(".time");let s=0;const a=e.querySelector(".preview"),o=this.videoData.preview.length;a.style.display="none",e.addEventListener("mousemove",(n=>{const r=this.actions.seek.getBoundingClientRect(),h=n.clientX-r.left;s=Math.max(0,Math.min(1,h/r.width));const d=t.getBoundingClientRect().width,l=window.innerWidth;let c=h-d/2;const u=r.left+c,v=u+d;if(u<12?c+=12-u:v>l-12&&(c-=v-(l-12)),t.style.left=c+"px",e.classList.add("hovered"),this.actions.seek.style.setProperty("--handle",100*s+"%"),i.textContent=formatTime(this.video.duration*s),o){const e=this.videoData.preview[Math.min(Math.floor(this.videoData.preview.length*s),this.videoData.preview.length-1)];a.style.backgroundImage=`url( '${this.videoDir}thumb/${e}' )`,a.style.display="block"}})),e.addEventListener("mouseleave",(()=>{e.classList.remove("hovered"),this.actions.seek.style.removeProperty("--hover")})),e.addEventListener("click",(()=>this.seek(s)))}async loadData(){if(!this.loaded)try{const e=await fetch("/api/video/"+this.videoId,{method:"post",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error("Error fetching video data");const t=await e.json();this.videoData=t.data??{},this.i18n=t.i18n??{},this.loaded=!0}catch(e){throw new Error(e)}}loadState(){this.playerState=JSON.parse(localStorage.getItem("__player__")??'{"volume":1,"playbackRate":1}'),this.videoState=JSON.parse(localStorage.getItem(this.videoId)??'{"progress":0,"resume":0}')}saveState(){localStorage.setItem("__player__",JSON.stringify(this.playerState)),localStorage.setItem(this.videoId,JSON.stringify(this.videoState))}getInfo(){const{meta:{video:e,audio:t,bitrate:i,size:s,duration:a},mimeType:o,content:n}=this.videoData,r={video:{duration:formatTime(a),resolution:`${e.width} × ${e.height}px`,size:formatFileSize(s),fps:e.fps+" fps",bitrate:formatBitrate(i),format:o,codec:(e.codec||"—").toUpperCase()},audio:{codec:(t.codec||"—").toUpperCase(),rate:formatFrequency(t.sample_rate),channels:["—","Mono","Stereo"][t.channels]},info:{source:n.source||"—",date:formatDate(n.date)}};for(const[e,t]of Object.entries(r)){const i=this.player.querySelector(".player-info--list."+e);for(const[e,s]of Object.entries(t))i.querySelector(`[info="${e}"] strong`).textContent=s}}async stream(){if(!this.ready)if(Hls.isSupported()){const e=new Hls({lowLatencyMode:!0});e.loadSource(this.videoDir+"stream/output.m3u8"),e.attachMedia(this.video)}else this.video.src=this.videoDir+"stream/output.m3u8"}async initVideo(){this.ready||(this.loaded||await this.loadMeta(),await this.stream(),this.video.poster=this.videoDir+this.videoData.thumbnail,this.video.currentTime=this.videoState.resume||0,this.video.load(),this.ready=!0,this.hideLoad(),this.showControls(),this.setVolume(this.playerState.volume),this.setPlaybackRate(this.playerState.playbackRate))}async loadWaveform(){this.loaded||await this.loadMeta();const e=this.controls.querySelector(".waveform"),t=e.getContext("2d",{alpha:!0}),i=this.videoData.waveform||[];let s,a=[];const o=(e,i)=>{const{h:a,barWidth:o}=s,n=i*o,r=a-e/100*a;t.fillRect(n,r,.8*o,e/100*a)},n=()=>{const t=window.devicePixelRatio||1,o=e.clientWidth*t,n=e.clientHeight*t;e.width===o&&e.height===n||(e.width=o,e.height=n);const h=Math.min(i.length,Math.floor(o/3)),d=i.length/h;a=Array.from({length:h},((e,t)=>Math.max(...i.slice(Math.floor(t*d),Math.floor((t+1)*d))))),s={w:o,h:n,barWidth:o/a.length},r()},r=()=>{const{w:e,h:i}=s,n=this.video.currentTime/this.video.duration,r=Math.floor(a.length*n);t.clearRect(0,0,e,i),t.fillStyle="rgba( 255 255 255 / 0.2 )",a.forEach(o),t.fillStyle="rgba( 224 47 47 / 0.6 )",a.slice(0,r).forEach(o)};new ResizeObserver(n).observe(e),this.video.addEventListener("timeupdate",r),n()}setActionState(e,t={}){for(const[t,i]of Object.entries(e))this.actions[t].disabled="toggle"===i?!this.actions[t].disabled:!i;for(const[e,i]of Object.entries(t))"toggle"===i?this.player.classList.toggle(e):i?this.player.classList.add(e):this.player.classList.remove(e)}showControls(){this.setActionState({},{controls:!0}),clearTimeout(this.controlsTimeout),this.video.paused||(this.controlsTimeout=setTimeout(this.hideControls.bind(this),3e3))}hideControls(){this.setActionState({},{controls:this.video.paused})}showSettings(){this.setActionState({},{settings:!0})}hideSettings(){this.setActionState({},{settings:!1})}toggleSettings(){this.setActionState({},{settings:"toggle"})}showInfo(){this.setActionState({},{info:!1})}hideInfo(){this.setActionState({},{info:!1})}toggleInfo(){this.setActionState({},{info:"toggle"})}showLoad(){this.setActionState({},{load:!0})}hideLoad(){this.setActionState({},{load:!1})}showOverlay(e,t){this.overlay.msg.textContent=t,this.overlay.icon.classList.remove(...this.overlay.icon.classList),this.overlay.icon.classList.add("icon","icon-"+e),this.setActionState({},{overlay:!0}),clearTimeout(this.overlayTimeout),this.overlayTimeout=setTimeout((()=>this.setActionState({},{overlay:!1})),800)}updateProgress(){this.videoState.progress=this.video.currentTime/this.video.duration*100||0,this.videoState.resume=this.video.currentTime%this.video.duration||0,this.saveState();const e=this.video.currentTime/this.video.duration*100;this.actions.seek.style.setProperty("--progress",(isNaN(e)?0:e)+"%"),this.updateTimeDisplay()}updateBuffer(){if(this.video.buffered.length>0){const e=this.video.buffered.end(this.video.buffered.length-1)/this.video.duration*100;this.actions.seek.style.setProperty("--buffered",(isNaN(e)?0:e)+"%")}}updateTimeDisplay(){this.timecode.querySelector(".cur").textContent=formatTime(this.video.currentTime),this.timecode.querySelector(".dur").textContent=formatTime(this.video.duration)}async play(){await this.video.play()}pause(){this.video.pause()}async togglePlay(){this.video.paused?await this.play():this.pause()}updatePlayState(){const e=this.video.paused,t=this.video.ended;this.setActionState({play:e&&!t,pause:!e&&!t,replay:t},{play:!e,pause:e,ended:t})}playOverlay(){this.video.paused?this.showOverlay("pause",this.i18n.overlay.pause):this.showOverlay("play",this.i18n.overlay.play)}isMuted(){return!this.video.volume>0}mute(){this.isMuted()||(this.previousVolume=this.video.volume,this.video.volume=0)}unmute(){this.isMuted()&&(this.video.volume=this.previousVolume||1)}toggleMute(){this.isMuted()?this.unmute():this.mute()}changeVolume(e){this.video.volume=Number(Math.max(0,Math.min(1,this.video.volume+e)).toFixed(2)),this.previousVolume=this.video.volume}setVolume(e){this.video.volume=Number(Math.max(0,Math.min(1,e)).toFixed(2)),this.previousVolume=this.video.volume}handleScroll(e){e.preventDefault(),throttle((e=>{this.changeVolume(e.deltaY<0?.05:-.05),this.volumeOverlay()})(e),50)}updateVolumeState(){const e=this.isMuted(),t=this.video.volume;this.setActionState({mute:!e,unmute:e},{muted:e}),this.actions.volume.value=t,this.actions.volume.style.setProperty("--width",100*t+"%"),this.playerState.volume=t,this.saveState()}volumeOverlay(){this.isMuted()?this.showOverlay("mute",this.i18n.overlay.mute):this.showOverlay("volume",this.i18n.overlay.volume+Math.round(100*this.video.volume)+"%")}begin(){this.seekDirection=!1,this.video.currentTime=0}end(){this.seekDirection=!0,this.video.currentTime=this.video.duration}skip(e){const t=Math.max(0,Math.min(this.video.duration,this.video.currentTime+e));this.seekDirection=t>=this.video.currentTime,this.video.currentTime=t}skipFrame(e){this.pause();const t=1/(this.videoData?.meta?.video?.fps??25),i=Math.max(0,Math.min(this.video.duration,this.video.currentTime+t*e));this.seekDirection=i>=this.video.currentTime,this.video.currentTime=i}seek(e){const t=this.video.duration*Math.max(0,Math.min(1,e>1?e/100:e));this.seekDirection=t>=this.video.currentTime,this.video.currentTime=t}seekOverlay(){this.showOverlay(this.seekDirection?"fastForward":"rewind",this.i18n.overlay.seek+formatTime(this.video.currentTime))}changePlaybackRate(e){this.setPlaybackRate(this.video.playbackRate+e)}setPlaybackRate(e){this.video.playbackRate=Math.max(.25,Math.min(2,e))}updatePlaybackRateState(){this.actions.pbr.querySelectorAll("[rate]").forEach((e=>{e.getAttribute("rate")==this.video.playbackRate?e.classList.add("active"):e.classList.remove("active")})),this.playerState.playbackRate=this.video.playbackRate,this.saveState()}playbackRateOverlay(){this.showOverlay("clock",this.i18n.overlay.playbackRate+this.video.playbackRate+"x")}isFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)}async maximize(){this.isFullscreen()||(this.container.requestFullscreen?await this.container.requestFullscreen():this.container.webkitRequestFullscreen?await this.container.webkitRequestFullscreen():this.container.mozRequestFullScreen&&await this.container.mozRequestFullScreen())}async minimize(){this.isFullscreen()&&(document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.mozCancelFullScreen&&await document.mozCancelFullScreen())}async toggleFullscreen(){this.isFullscreen()?await this.minimize():await this.maximize()}updateFullscreenState(){const e=this.isFullscreen();this.setActionState({maximize:!e,minimize:e},{fullscreen:e}),e?this.showOverlay("maximize",this.i18n.overlay.maximize):this.showOverlay("minimize",this.i18n.overlay.minimize)}download(){const e=this.videoDir+this.videoData.fileName,t=document.createElement("a");t.href=e,t.download="video.mp4",t.target="_blank",t.click()}}document.addEventListener("DOMContentLoaded",(()=>new VideoPlayer));