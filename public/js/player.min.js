class VideoPlayer{constructor(){this.player=document.querySelector(".player"),this.video=this.player.querySelector("video"),this.controls=this.player.querySelector(".player-controls"),this.videoId=this.player.getAttribute("videoId"),this.videoDir="/media/"+this.videoId+"/",this.videoData={},this.loaded=!1,this.ready=!1,this.loadMeta().then((()=>{this.loadState(),this.saveState(),this.initVideo(),this.loadWaveform()}))}async loadMeta(){if(!this.loaded)try{const e=await fetch("/api/video/"+this.videoId,{method:"post",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error("Error fetching video data");this.videoData=await e.json(),this.loaded=!0}catch(e){throw new Error(e)}}loadState(){this.playerState=JSON.parse(localStorage.getItem("__player__")??'{ "volume": 1, "playbackRate": 1 }'),this.videoState=JSON.parse(localStorage.getItem(this.videoId)??'{ "progress": 0 }')}saveState(){localStorage.setItem("__player__",JSON.stringify(this.playerState)),localStorage.setItem(this.videoId,JSON.stringify(this.videoState))}async stream(){if(this.ready)return;const e=524288,t=(await fetch(this.videoDir+this.videoData.fileName)).body.getReader(),a=new ReadableStream({async pull(a){let{done:i,value:o}=await t.read();if(i)return a.close();for(let t=0;t<o.length;t+=e)a.enqueue(o.slice(t,t+e))}}),i=await new Response(a).blob(),o=URL.createObjectURL(i);this.video.src=o}async initVideo(){this.ready||(this.loaded||await this.loadMeta(),await this.stream(),this.video.poster=this.videoDir+"poster.jpg",this.video.load(),this.ready=!0,this.hideLoad())}async loadWaveform(){this.loaded||await this.loadMeta();const e=this.controls.querySelector(".waveform"),t=e.getContext("2d",{alpha:!0}),a=this.videoData.waveform||[];let i,o=[];const s=(e,a)=>{const{h:o,barWidth:s}=i,r=a*s,d=o-e/100*o;t.fillRect(r,d,.8*s,e/100*o)},r=()=>{const t=window.devicePixelRatio||1,s=e.clientWidth*t,r=e.clientHeight*t;e.width===s&&e.height===r||(e.width=s,e.height=r);const h=Math.min(a.length,Math.floor(s/3)),l=a.length/h;o=Array.from({length:h},((e,t)=>Math.max(...a.slice(Math.floor(t*l),Math.floor((t+1)*l))))),i={w:s,h:r,barWidth:s/o.length},d()},d=()=>{const{w:e,h:a}=i,r=this.video.currentTime/this.video.duration,d=Math.floor(o.length*r);t.clearRect(0,0,e,a),t.fillStyle="rgba( 255 255 255 / 0.2 )",o.forEach(s),t.fillStyle="rgba( 224 47 47 / 0.6 )",o.slice(0,d).forEach(s)};new ResizeObserver(r).observe(e),this.video.addEventListener("timeupdate",d),r()}showLoad(){this.player.classList.add("load")}hideLoad(){this.player.classList.remove("load")}}document.addEventListener("DOMContentLoaded",(()=>new VideoPlayer));