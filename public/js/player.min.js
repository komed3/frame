class VideoPlayer{bindings=["f","j","k","l","m"," ",",",".","+","-","0","1","2","3","4","5","6","7","8","9","ArrowUp","ArrowLeft","ArrowRight","ArrowDown","Tab","Home","End","Escape","F6","F7","F8","F9","F11"];constructor(){this.player=document.querySelector(".player"),this.container=this.player.querySelector(".player-container"),this.video=this.player.querySelector("video"),this.controls=this.player.querySelector(".player-controls"),this.playlists=this.controls.querySelector(".player-playlists"),this.timecode=this.controls.querySelector(".timecode"),this.actions=this.initActions(),this.setActionState({pause:!1,replay:!1,prev:!1,next:!1,minimize:!1,unmute:!1}),this.overlay={icon:this.player.querySelector(".player-overlay .icon"),msg:this.player.querySelector(".player-overlay .msg")},this.videoId=this.player.getAttribute("videoId"),this.videoDir=`/media/${this.videoId}/`,this.videoData={},this.loaded=!1,this.ready=!1,this.seekDirection=!0,this.previousVolume=0,this.controlsTimeout=null,this.overlayTimeout=null,this.initEventHandlers(),this.initKeyBindings(),this.loadData().then((()=>{this.loadState(),this.saveState(),this.getInfo(),this.initSeekbar(),this.loadWaveform(),this.loadPlaylist(),this.initVideo()}))}initActions(){const t={};return this.controls.querySelectorAll("[action]").forEach((e=>{t[e.getAttribute("action")]=e})),t}initEventHandlers(){this.container.addEventListener("mousemove",this.showControls.bind(this)),this.container.addEventListener("mouseleave",this.hideControls.bind(this)),this.actions.interact.addEventListener("click",this.togglePlay.bind(this)),this.actions.play.addEventListener("click",this.play.bind(this)),this.actions.pause.addEventListener("click",this.pause.bind(this)),this.actions.replay.addEventListener("click",this.play.bind(this)),this.actions.interact.addEventListener("wheel",this.handleScroll.bind(this)),this.actions.mute.addEventListener("click",this.mute.bind(this)),this.actions.unmute.addEventListener("click",this.unmute.bind(this)),this.actions.volume.addEventListener("input",(t=>{this.setVolume(t.target.value),setTimeout((()=>t.target.blur()),10)})),this.actions.pbr.addEventListener("click",(t=>this.setPlaybackRate(t.target.getAttribute("rate")))),this.actions.rewind.addEventListener("click",(()=>this.skip(-5))),this.actions.fastForward.addEventListener("click",(()=>this.skip(5))),this.actions.playlist.addEventListener("click",this.togglePlaylists.bind(this)),this.actions.prev.addEventListener("click",this.prevPlaylistItem.bind(this)),this.actions.next.addEventListener("click",this.nextPlaylistItem.bind(this)),this.playlists.querySelectorAll("[pl]").forEach((t=>t.addEventListener("click",this.handlePlaylist.bind(this)))),this.actions.timecode.addEventListener("click",this.toggleTimeDisplay.bind(this)),this.actions.interact.addEventListener("click",this.hideSettings.bind(this)),this.actions.download.addEventListener("click",this.download.bind(this)),this.actions.settings.addEventListener("click",this.toggleSettings.bind(this)),this.actions.info.addEventListener("click",this.toggleInfo.bind(this)),document.addEventListener("fullscreenchange",this.updateFullscreenState.bind(this)),this.container.addEventListener("dblclick",this.toggleFullscreen.bind(this)),this.actions.maximize.addEventListener("click",this.maximize.bind(this)),this.actions.minimize.addEventListener("click",this.minimize.bind(this)),this.video.addEventListener("waiting",this.showLoad.bind(this)),this.video.addEventListener("canplay",this.hideLoad.bind(this)),this.video.addEventListener("playing",this.hideLoad.bind(this)),this.video.addEventListener("play",this.updatePlayState.bind(this)),this.video.addEventListener("play",this.hideControls.bind(this)),this.video.addEventListener("pause",this.updatePlayState.bind(this)),this.video.addEventListener("pause",this.showControls.bind(this)),this.video.addEventListener("ended",this.updatePlayState.bind(this)),this.video.addEventListener("ended",this.showControls.bind(this)),this.video.addEventListener("volumechange",this.updateVolumeState.bind(this)),this.video.addEventListener("ratechange",this.updatePlaybackRateState.bind(this)),this.video.addEventListener("timeupdate",this.updateProgress.bind(this)),this.video.addEventListener("loadedmetadata",this.updateTimeDisplay.bind(this)),this.video.addEventListener("progress",this.updateBuffer.bind(this))}initKeyBindings(){document.addEventListener("keydown",(t=>{if("INPUT"!==t.target.tagName&&this.bindings.includes(t.key))switch(t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation(),t.key){case" ":case"k":case"F7":this.togglePlay(),this.playOverlay();break;case"m":case"F9":this.toggleMute(),this.volumeOverlay();break;case"Tab":this.nextPlaylistItem();break;case"ArrowUp":this.changeVolume(.1),this.volumeOverlay();break;case"ArrowDown":this.changeVolume(-.1),this.volumeOverlay();break;case"ArrowLeft":case"j":case"F6":this.skip(-5),this.seekOverlay();break;case"ArrowRight":case"l":case"F8":this.skip(5),this.seekOverlay();break;case"Home":this.begin(),this.seekOverlay();break;case"End":this.end(),this.seekOverlay();break;case",":this.skipFrame(-1);break;case".":this.skipFrame(1);break;case"+":this.changePlaybackRate(.25),this.playbackRateOverlay();break;case"-":this.changePlaybackRate(-.25),this.playbackRateOverlay();break;case"F11":case"f":this.toggleFullscreen();break;case"Escape":this.minimize();break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":this.seek(10*Number(t.key)),this.seekOverlay();break}}))}initSeekbar(){const t=this.controls.querySelector(".progress"),e=t.querySelector(".hover"),i=t.querySelector(".time");let s=0;const a=t.querySelector(".preview"),o=this.videoData.preview.length;a.style.display="none",t.addEventListener("mousemove",(n=>{const l=this.actions.seek.getBoundingClientRect(),r=n.clientX-l.left;s=Math.max(0,Math.min(1,r/l.width));const h=e.getBoundingClientRect().width,d=window.innerWidth;let c=r-h/2;const v=l.left+c,u=v+h;if(v<12?c+=12-v:u>d-12&&(c-=u-(d-12)),e.style.left=c+"px",t.classList.add("hovered"),this.actions.seek.style.setProperty("--handle",100*s+"%"),i.textContent=formatTime(this.video.duration*s),o){const t=this.videoData.preview[Math.min(Math.floor(this.videoData.preview.length*s),this.videoData.preview.length-1)];a.style.backgroundImage=`url( '${this.videoDir}thumb/${t}' )`,a.style.display="block"}})),t.addEventListener("mouseleave",(()=>{t.classList.remove("hovered"),this.actions.seek.style.removeProperty("--hover")})),t.addEventListener("click",(()=>this.seek(s)))}async loadData(){if(!this.loaded)try{const t=await fetch("/api/video/"+this.videoId,{method:"post",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Error fetching video data");const e=await t.json();this.videoData=e.data??{},this.i18n=e.i18n??{},this.loaded=!0}catch(t){throw new Error(t)}}loadState(){this.playerState=JSON.parse(localStorage.getItem("__player__")??'{"volume":1,"playbackRate":1,"timeReverse":0}'),this.videoState=JSON.parse(localStorage.getItem(this.videoId)??'{"progress":0,"resume":0}')}saveState(){localStorage.setItem("__player__",JSON.stringify(this.playerState)),localStorage.setItem(this.videoId,JSON.stringify(this.videoState))}getInfo(){const{meta:{video:t,audio:e,bitrate:i,size:s,duration:a},mimeType:o,content:n}=this.videoData,l={video:{duration:formatTime(a),resolution:`${t.width} × ${t.height}px`,size:formatFileSize(s),fps:t.fps+" fps",bitrate:formatBitrate(i),format:o,codec:(t.codec||"—").toUpperCase()},audio:{codec:(e.codec||"—").toUpperCase(),rate:formatFrequency(e.sample_rate),channels:["—","Mono","Stereo"][e.channels]},info:{source:n.source||"—",date:formatDate(n.date)}};for(const[t,e]of Object.entries(l)){const i=this.player.querySelector(".player-info--list."+t);for(const[t,s]of Object.entries(e))i.querySelector(`[info="${t}"] strong`).textContent=s}}async stream(){if(!this.ready)if(Hls.isSupported()){const t=new Hls({lowLatencyMode:!0});t.loadSource(this.videoDir+"stream/output.m3u8"),t.attachMedia(this.video)}else this.video.src=this.videoDir+"stream/output.m3u8"}async initVideo(){this.ready||(this.loaded||await this.loadMeta(),await this.stream(),this.video.poster=this.videoDir+this.videoData.thumbnail,this.video.currentTime=this.videoState.resume||0,this.video.load(),this.ready=!0,this.hideLoad(),this.showControls(),this.setVolume(this.playerState.volume),this.setPlaybackRate(this.playerState.playbackRate))}async loadWaveform(){this.loaded||await this.loadMeta();const t=this.controls.querySelector(".waveform"),e=t.getContext("2d",{alpha:!0}),i=this.videoData.waveform||[];let s,a=[];const o=(t,i)=>{const{h:a,barWidth:o}=s,n=i*o,l=a-t/100*a;e.fillRect(n,l,.8*o,t/100*a)},n=()=>{const e=window.devicePixelRatio||1,o=t.clientWidth*e,n=t.clientHeight*e;t.width===o&&t.height===n||(t.width=o,t.height=n);const r=Math.min(i.length,Math.floor(o/3)),h=i.length/r;a=Array.from({length:r},((t,e)=>Math.max(...i.slice(Math.floor(e*h),Math.floor((e+1)*h))))),s={w:o,h:n,barWidth:o/a.length},l()},l=()=>{const{w:t,h:i}=s,n=this.video.currentTime/this.video.duration,l=Math.floor(a.length*n);e.clearRect(0,0,t,i),e.fillStyle="rgba( 255 255 255 / 0.2 )",a.forEach(o),e.fillStyle="rgba( 224 47 47 / 0.6 )",a.slice(0,l).forEach(o)};new ResizeObserver(n).observe(t),this.video.addEventListener("timeupdate",l),n()}setActionState(t,e={}){for(const[e,i]of Object.entries(t))this.actions[e].disabled="toggle"===i?!this.actions[e].disabled:!i;for(const[t,i]of Object.entries(e))"toggle"===i?this.player.classList.toggle(t):i?this.player.classList.add(t):this.player.classList.remove(t)}showControls(){this.setActionState({},{controls:!0}),clearTimeout(this.controlsTimeout),this.video.paused||(this.controlsTimeout=setTimeout(this.hideControls.bind(this),3e3))}hideControls(){this.setActionState({},{controls:this.video.paused})}showPlaylists(){this.setActionState({},{playlist:!0,settings:!1,info:!1})}hidePlaylists(){this.setActionState({},{playlist:!1})}togglePlaylists(){this.setActionState({},{playlist:"toggle",settings:!1,info:!1})}showSettings(){this.setActionState({},{playlist:!1,settings:!0,info:!1})}hideSettings(){this.setActionState({},{settings:!1})}toggleSettings(){this.setActionState({},{playlist:!1,settings:"toggle",info:!1})}showInfo(){this.setActionState({},{playlist:!1,settings:!1,info:!1})}hideInfo(){this.setActionState({},{info:!1})}toggleInfo(){this.setActionState({},{playlist:!1,settings:!1,info:"toggle"})}showLoad(){this.setActionState({},{load:!0})}hideLoad(){this.setActionState({},{load:!1})}showOverlay(t,e){this.overlay.msg.textContent=e,this.overlay.icon.classList.remove(...this.overlay.icon.classList),this.overlay.icon.classList.add("icon","icon-"+t),this.setActionState({},{overlay:!0}),clearTimeout(this.overlayTimeout),this.overlayTimeout=setTimeout((()=>this.setActionState({},{overlay:!1})),800)}updateProgress(){this.videoState.progress=this.video.currentTime/this.video.duration*100||0,this.videoState.resume=this.video.currentTime%this.video.duration||0,this.saveState();const t=this.video.currentTime/this.video.duration*100;this.actions.seek.style.setProperty("--progress",(isNaN(t)?0:t)+"%"),this.updateTimeDisplay()}updateBuffer(){if(this.video.buffered.length>0){const t=this.video.buffered.end(this.video.buffered.length-1)/this.video.duration*100;this.actions.seek.style.setProperty("--buffered",(isNaN(t)?0:t)+"%")}}updateTimeDisplay(){const t=this.timecode.querySelector(".cur");this.playerState.timeReverse?t.textContent="-"+formatTime(this.video.duration-this.video.currentTime):t.textContent=formatTime(this.video.currentTime),this.timecode.querySelector(".dur").textContent=formatTime(this.video.duration)}toggleTimeDisplay(){this.playerState.timeReverse=!this.playerState.timeReverse,this.saveState(),this.updateTimeDisplay()}async play(){await this.video.play()}pause(){this.video.pause()}async togglePlay(){this.video.paused?await this.play():this.pause()}updatePlayState(){const t=this.video.paused,e=this.video.ended;this.setActionState({play:t&&!e,pause:!t&&!e,replay:e},{play:!t,pause:t,ended:e})}playOverlay(){this.video.paused?this.showOverlay("pause",this.i18n.overlay.pause):this.showOverlay("play",this.i18n.overlay.play)}isMuted(){return!this.video.volume>0}mute(){this.isMuted()||(this.previousVolume=this.video.volume,this.video.volume=0)}unmute(){this.isMuted()&&(this.video.volume=this.previousVolume||1)}toggleMute(){this.isMuted()?this.unmute():this.mute()}changeVolume(t){this.video.volume=Number(Math.max(0,Math.min(1,this.video.volume+t)).toFixed(2)),this.previousVolume=this.video.volume}setVolume(t){this.video.volume=Number(Math.max(0,Math.min(1,t)).toFixed(2)),this.previousVolume=this.video.volume}handleScroll(t){t.preventDefault(),throttle((t=>{this.changeVolume(t.deltaY<0?.05:-.05),this.volumeOverlay()})(t),50)}updateVolumeState(){const t=this.isMuted(),e=this.video.volume;this.setActionState({mute:!t,unmute:t},{muted:t}),this.actions.volume.value=e,this.actions.volume.style.setProperty("--width",100*e+"%"),this.playerState.volume=e,this.saveState()}volumeOverlay(){this.isMuted()?this.showOverlay("mute",this.i18n.overlay.mute):this.showOverlay("volume",this.i18n.overlay.volume+Math.round(100*this.video.volume)+"%")}begin(){this.seekDirection=!1,this.video.currentTime=0}end(){this.seekDirection=!0,this.video.currentTime=this.video.duration}skip(t){const e=Math.max(0,Math.min(this.video.duration,this.video.currentTime+t));this.seekDirection=e>=this.video.currentTime,this.video.currentTime=e}skipFrame(t){this.pause();const e=1/(this.videoData?.meta?.video?.fps??25),i=Math.max(0,Math.min(this.video.duration,this.video.currentTime+e*t));this.seekDirection=i>=this.video.currentTime,this.video.currentTime=i}seek(t){const e=this.video.duration*Math.max(0,Math.min(1,t>1?t/100:t));this.seekDirection=e>=this.video.currentTime,this.video.currentTime=e}seekOverlay(){this.showOverlay(this.seekDirection?"fastForward":"rewind",this.i18n.overlay.seek+formatTime(this.video.currentTime))}changePlaybackRate(t){this.setPlaybackRate(this.video.playbackRate+t)}setPlaybackRate(t){this.video.playbackRate=Math.max(.25,Math.min(2,t))}updatePlaybackRateState(){this.actions.pbr.querySelectorAll("[rate]").forEach((t=>{t.getAttribute("rate")==this.video.playbackRate?t.classList.add("active"):t.classList.remove("active")})),this.playerState.playbackRate=this.video.playbackRate,this.saveState()}playbackRateOverlay(){this.showOverlay("clock",this.i18n.overlay.playbackRate+this.video.playbackRate+"x")}async loadPlaylist(){try{const t=this.player.getAttribute("playlist");if(!t)return;const e=await fetch("/api/list/"+encodeURIComponent(t),{method:"post"});if(!e.ok)return;const i=await e.json();if(this.playlist=i.list||null,!this.playlist)return;this.playlistIndex=this.playlist.videos.indexOf(this.videoId),-1===this.playlistIndex&&(this.playlistIndex=0),this.setActionState({prev:this.playlistIndex>0,next:this.playlistIndex<this.playlist.videos.length-1})}catch{}}playlistItem(t){if(!this.playlist||0==this.playlist.videos.length)return;const e=this.playlist.videos[Math.max(0,Math.min(this.playlist.videos.length-1,t))];e&&(location.href=`/watch/${e}?list=${this.playlist.id}`)}prevPlaylistItem(){this.playlistItem(this.playlistIndex-1)}nextPlaylistItem(){this.playlistItem(this.playlistIndex+1)}async createPlaylist(t){const e=await fetch("/api/list/new",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,videos:[this.videoId]})});if(!e.ok)return;const{id:i,list:s}=await e.json();this.playlists.querySelector(".player-playlists--list").insertAdjacentHTML("beforeend",`<div class="player-playlists--list-item selected" list="${i}"><a href="/list/${i}" class="name">${s.name}</a><button pl="add" title="${this.i18n.action.pl.add}"><i class="icon icon-plus"></i></button><button pl="rmv" title="${this.i18n.action.pl.remove}"><i class="icon icon-minus"></i></button></div>`)}async addToPlaylist(t){(await fetch("/api/list/"+encodeURIComponent(t)+"/add",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({videos:[this.videoId]})})).ok&&this.playlists.querySelector(`[list="${t}"]`).classList.add("selected")}async rmvFormPlaylist(t){(await fetch("/api/list/"+encodeURIComponent(t)+"/rmv",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({videos:[this.videoId]})})).ok&&(this.playlist&&this.playlist.id===t?location.href="/watch/"+this.videoId:this.playlists.querySelector(`[list="${t}"]`).classList.remove("selected"))}async handlePlaylist(t){const e=t.target.closest("[pl]"),i=(e.closest("[list]")||t.target).getAttribute("list"),s=this.playlists.querySelector('input[name="playlist"]'),a=s.value;switch(s.value="",e.getAttribute("pl")){case"new":await this.createPlaylist(a);break;case"add":await this.addToPlaylist(i);break;case"rmv":await this.rmvFormPlaylist(i);break;default:break}}isFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)}async maximize(){this.isFullscreen()||(this.container.requestFullscreen?await this.container.requestFullscreen():this.container.webkitRequestFullscreen?await this.container.webkitRequestFullscreen():this.container.mozRequestFullScreen&&await this.container.mozRequestFullScreen())}async minimize(){this.isFullscreen()&&(document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.mozCancelFullScreen&&await document.mozCancelFullScreen())}async toggleFullscreen(){this.isFullscreen()?await this.minimize():await this.maximize()}updateFullscreenState(){const t=this.isFullscreen();this.setActionState({maximize:!t,minimize:t},{fullscreen:t}),t?this.showOverlay("maximize",this.i18n.overlay.maximize):this.showOverlay("minimize",this.i18n.overlay.minimize)}download(){const t=this.videoDir+this.videoData.fileName,e=document.createElement("a");e.href=t,e.download="video.mp4",e.target="_blank",e.click()}}document.addEventListener("DOMContentLoaded",(()=>new VideoPlayer));