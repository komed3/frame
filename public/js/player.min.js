class VideoPlayer{bindings=["f","j","k","l","m"," ",",",".","ArrowUp","ArrowLeft","ArrowRight","ArrowDown","Home","End","Escape","F11"];constructor(){this.player=document.querySelector(".player"),this.container=this.player.querySelector(".player-container"),this.video=this.player.querySelector("video"),this.controls=this.player.querySelector(".player-controls"),this.timecode=this.controls.querySelector(".timecode"),this.actions=this.initActions(),this.setActionState({pause:!1,replay:!1,minimize:!1,unmute:!1}),this.overlay={icon:this.player.querySelector(".player-overlay .icon"),msg:this.player.querySelector(".player-overlay .msg")},this.videoId=this.player.getAttribute("videoId"),this.videoDir="/media/"+this.videoId+"/",this.videoData={},this.loaded=!1,this.ready=!1,this.previousVolume=0,this.controlsTimeout=null,this.overlayTimeout=null,this.initEventHandlers(),this.initKeyBindings(),this.loadMeta().then((()=>{this.loadState(),this.saveState(),this.initSeekbar(),this.loadWaveform(),this.initVideo(),this.setVolume(this.playerState.volume)}))}initActions(){const e={};return this.controls.querySelectorAll("[action]").forEach((t=>{e[t.getAttribute("action")]=t})),e}initEventHandlers(){this.container.addEventListener("mousemove",this.showControls.bind(this)),this.container.addEventListener("mouseleave",this.hideControls.bind(this)),this.actions.interact.addEventListener("click",this.togglePlay.bind(this)),this.actions.play.addEventListener("click",this.play.bind(this)),this.actions.pause.addEventListener("click",this.pause.bind(this)),this.actions.replay.addEventListener("click",this.play.bind(this)),this.actions.mute.addEventListener("click",this.mute.bind(this)),this.actions.unmute.addEventListener("click",this.unmute.bind(this)),this.actions.volume.addEventListener("input",(e=>{this.setVolume(e.target.value),setTimeout((()=>e.target.blur()),10)})),this.actions.rewind.addEventListener("click",(()=>this.skip(-5))),this.actions.fastForward.addEventListener("click",(()=>this.skip(5))),document.addEventListener("fullscreenchange",this.updateFullscreenState.bind(this)),this.container.addEventListener("dblclick",this.toggleFullscreen.bind(this)),this.actions.maximize.addEventListener("click",this.maximize.bind(this)),this.actions.minimize.addEventListener("click",this.minimize.bind(this)),this.video.addEventListener("waiting",this.showLoad.bind(this)),this.video.addEventListener("canplay",this.hideLoad.bind(this)),this.video.addEventListener("playing",this.hideLoad.bind(this)),this.video.addEventListener("play",this.updatePlayState.bind(this)),this.video.addEventListener("play",this.hideControls.bind(this)),this.video.addEventListener("pause",this.updatePlayState.bind(this)),this.video.addEventListener("pause",this.showControls.bind(this)),this.video.addEventListener("ended",this.updatePlayState.bind(this)),this.video.addEventListener("ended",this.showControls.bind(this)),this.video.addEventListener("volumechange",this.updateVolumeState.bind(this)),this.video.addEventListener("timeupdate",this.updateProgress.bind(this)),this.video.addEventListener("loadedmetadata",this.updateTimeDisplay.bind(this)),this.video.addEventListener("progress",this.updateBuffer.bind(this))}initKeyBindings(){document.addEventListener("keydown",(e=>{if("INPUT"!==e.target.tagName&&this.bindings.includes(e.key))switch(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),e.key){case" ":case"k":this.togglePlay();break;case"m":this.toggleMute();break;case"ArrowUp":this.changeVolume(.1);break;case"ArrowDown":this.changeVolume(-.1);break;case"ArrowLeft":case"j":this.skip(-5);break;case"ArrowRight":case"l":this.skip(5);break;case"Home":this.begin();break;case"End":this.end();break;case",":this.skipFrame(-1);break;case".":this.skipFrame(1);break;case"F11":case"f":this.toggleFullscreen();break;case"Escape":this.minimize();break}}))}initSeekbar(){const e=this.controls.querySelector(".progress"),t=e.querySelector(".time");let i=0;const s=e.querySelector(".preview"),a=this.videoData.preview.length;s.style.display="none",e.addEventListener("mousemove",(o=>{const n=this.actions.seek.getBoundingClientRect();if(i=Math.max(0,Math.min(1,(o.clientX-n.left)/n.width)),e.classList.add("hovered"),this.actions.seek.style.setProperty("--handle",100*i+"%"),t.textContent=formatTime(this.video.duration*i),a){const e=this.videoData.preview[Math.min(Math.floor(this.videoData.preview.length*i),this.videoData.preview.length-1)];s.style.backgroundImage=`url( '/media/${this.videoId}/thumb/${e}' )`,s.style.display="block"}})),e.addEventListener("mouseleave",(()=>{e.classList.remove("hovered"),this.actions.seek.style.removeProperty("--hover")})),e.addEventListener("click",(()=>this.seek(i)))}async loadMeta(){if(!this.loaded)try{const e=await fetch("/api/video/"+this.videoId,{method:"post",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error("Error fetching video data");this.videoData=await e.json(),this.loaded=!0}catch(e){throw new Error(e)}}loadState(){this.playerState=JSON.parse(localStorage.getItem("__player__")??'{ "volume": 1, "playbackRate": 1 }'),this.videoState=JSON.parse(localStorage.getItem(this.videoId)??'{ "progress": 0 }')}saveState(){localStorage.setItem("__player__",JSON.stringify(this.playerState)),localStorage.setItem(this.videoId,JSON.stringify(this.videoState))}async stream(){if(this.ready)return;const e=524288,t=(await fetch(this.videoDir+this.videoData.fileName)).body.getReader(),i=new ReadableStream({async pull(i){let{done:s,value:a}=await t.read();if(s)return i.close();for(let t=0;t<a.length;t+=e)i.enqueue(a.slice(t,t+e))}}),s=await new Response(i).blob(),a=URL.createObjectURL(s);this.video.src=a}async initVideo(){this.ready||(this.loaded||await this.loadMeta(),await this.stream(),this.video.poster=this.videoDir+"poster.jpg",this.video.currentTime=this.videoState.progress||0,this.video.load(),this.ready=!0,this.hideLoad(),this.showControls())}async loadWaveform(){this.loaded||await this.loadMeta();const e=this.controls.querySelector(".waveform"),t=e.getContext("2d",{alpha:!0}),i=this.videoData.waveform||[];let s,a=[];const o=(e,i)=>{const{h:a,barWidth:o}=s,n=i*o,r=a-e/100*a;t.fillRect(n,r,.8*o,e/100*a)},n=()=>{const t=window.devicePixelRatio||1,o=e.clientWidth*t,n=e.clientHeight*t;e.width===o&&e.height===n||(e.width=o,e.height=n);const h=Math.min(i.length,Math.floor(o/3)),d=i.length/h;a=Array.from({length:h},((e,t)=>Math.max(...i.slice(Math.floor(t*d),Math.floor((t+1)*d))))),s={w:o,h:n,barWidth:o/a.length},r()},r=()=>{const{w:e,h:i}=s,n=this.video.currentTime/this.video.duration,r=Math.floor(a.length*n);t.clearRect(0,0,e,i),t.fillStyle="rgba( 255 255 255 / 0.2 )",a.forEach(o),t.fillStyle="rgba( 224 47 47 / 0.6 )",a.slice(0,r).forEach(o)};new ResizeObserver(n).observe(e),this.video.addEventListener("timeupdate",r),n()}setActionState(e,t={}){for(const[t,i]of Object.entries(e))this.actions[t].disabled=!i;for(const[e,i]of Object.entries(t))i?this.player.classList.add(e):this.player.classList.remove(e)}showControls(){this.setActionState({},{controls:!0}),clearTimeout(this.controlsTimeout),this.video.paused||(this.controlsTimeout=setTimeout(this.hideControls.bind(this),3e3))}hideControls(){this.setActionState({},{controls:this.video.paused})}showLoad(){this.setActionState({},{load:!0})}hideLoad(){this.setActionState({},{load:!1})}showOverlay(e,t){this.overlay.msg.textContent=t,this.overlay.icon.classList.remove(...this.overlay.icon.classList),this.overlay.icon.classList.add("icon","icon-"+e),this.setActionState({},{overlay:!0}),clearTimeout(this.overlayTimeout),this.overlayTimeout=setTimeout((()=>this.setActionState({},{overlay:!1})),800)}updateProgress(){this.videoState.progress=this.video.currentTime||0,this.saveState();const e=this.video.currentTime/this.video.duration*100;this.actions.seek.style.setProperty("--progress",(isNaN(e)?0:e)+"%"),this.updateTimeDisplay()}updateBuffer(){if(this.video.buffered.length>0){const e=this.video.buffered.end(this.video.buffered.length-1)/this.video.duration*100;this.actions.seek.style.setProperty("--buffered",(isNaN(e)?0:e)+"%")}}updateTimeDisplay(){this.timecode.querySelector(".cur").textContent=formatTime(this.video.currentTime),this.timecode.querySelector(".dur").textContent=formatTime(this.video.duration)}async play(){await this.video.play()}pause(){this.video.pause()}async togglePlay(){this.video.paused?await this.play():this.pause()}updatePlayState(){const e=this.video.paused,t=this.video.ended;this.setActionState({play:e&&!t,pause:!e&&!t,replay:t},{play:!e,pause:e,ended:t})}isMuted(){return!this.video.volume>0}mute(){this.isMuted()||(this.previousVolume=this.video.volume,this.video.volume=0)}unmute(){this.isMuted()&&(this.video.volume=this.previousVolume||1)}toggleMute(){this.isMuted()?this.unmute():this.mute()}changeVolume(e){this.video.volume=Number(Math.max(0,Math.min(1,this.video.volume+e)).toFixed(2)),this.previousVolume=this.video.volume}setVolume(e){this.video.volume=Number(Math.max(0,Math.min(1,e)).toFixed(2)),this.previousVolume=this.video.volume}updateVolumeState(){const e=this.isMuted(),t=this.video.volume;this.setActionState({mute:!e,unmute:e},{muted:e}),this.actions.volume.value=t,this.actions.volume.style.setProperty("--width",100*t+"%"),this.playerState.volume=t,this.saveState()}begin(){this.video.currentTime=0}end(){this.video.currentTime=this.video.duration}skip(e){this.video.currentTime=Math.max(0,Math.min(this.video.duration,this.video.currentTime+e))}skipFrame(e){const t=1/(this.videoData?.meta?.video?.fps??25);this.pause(),this.video.currentTime=Math.max(0,Math.min(this.video.duration,this.video.currentTime+t*e))}seek(e){this.video.currentTime=this.video.duration*Math.max(0,Math.min(1,e>1?e/100:e))}isFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)}async maximize(){this.isFullscreen()||(this.container.requestFullscreen?await this.container.requestFullscreen():this.container.webkitRequestFullscreen?await this.container.webkitRequestFullscreen():this.container.mozRequestFullScreen&&await this.container.mozRequestFullScreen())}async minimize(){this.isFullscreen()&&(document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.mozCancelFullScreen&&await document.mozCancelFullScreen())}async toggleFullscreen(){this.isFullscreen()?await this.minimize():await this.maximize()}updateFullscreenState(){const e=this.isFullscreen();this.setActionState({maximize:!e,minimize:e},{fullscreen:e}),e?this.showOverlay("maximize","Video in full screen"):this.showOverlay("minimize","Leave full screen")}}document.addEventListener("DOMContentLoaded",(()=>new VideoPlayer));