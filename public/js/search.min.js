class VideoSearch{constructor(){this.form=document.querySelector(".frame-search--form"),this.loader=document.querySelector(".frame-search--loader"),this.results=document.querySelector(".frame-search--results-grid"),this.empty=document.querySelector(".frame-search--empty"),this.more=document.querySelector(".frame-search--more"),this.wait=!1,this.query=null,this.offset=0,this.initEventHandlers(),this.loadFromUrl()}initEventHandlers(){this.form.addEventListener("submit",this.submit.bind(this)),this.form.querySelectorAll("select").forEach((e=>e.addEventListener("change",this.submit.bind(this)))),this.more.querySelector("button").addEventListener("click",(async()=>{this.query.offset=this.offset,await this.search()}))}async loadFromUrl(){this.query=Object.fromEntries(new URLSearchParams(window.location.search)),this.query&&this.query.q?(this.wait=!0,this.form.querySelector('[name="q"]').value=this.query.q,this.form.querySelector('[name="sort"]').value=this.query.sort||"date",this.form.querySelector('[name="order"]').value=this.query.order||"desc",this.form.querySelector('[name="author"]').value=this.query.author||"",this.form.querySelector('[name="category"]').value=this.query.category||"",this.form.querySelector('[name="tag"]').value=this.query.tag||"",this.form.querySelector('[name="year"]').value=this.query.year||"",this.form.querySelector('[name="lang"]').value=this.query.lang||"",this.wait=!1,delete this.query.offset,delete this.query.limit,await this.search()):location.href="/"}addVideo(e){if(!e||!e.id)return;const t=document.createElement("a");t.classList.add("frame-videogrid--item"),t.href="/watch/"+e.id,t.setAttribute("title",e.title),t.setAttribute("video",e.id);const{progress:r}=JSON.parse(localStorage.getItem(e.id)??'{"progress":0}');t.style.setProperty("--progress",r+"%"),t.innerHTML=`<img class="frame-videogrid--item-preview" src="/media/${e.id}/${e.thumbnail}" alt= "Thumbnail" /><div class="frame-videogrid--item-overlay"><span>${e.title}</span><time>${formatTime(e.duration)}</time></div><div class="frame-videogrid--item-progress"></div>`,this.results.appendChild(t)}async search(){if(this.wait)return;this.wait=!0,this.loader.classList.remove("hidden"),this.more.classList.add("hidden");const e=await fetch("/api/search",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.query)});if(!e.ok)return;const{results:t,total:r,offset:s,limit:i}=await e.json();this.loader.classList.add("hidden"),this.empty.classList[0===r?"remove":"add"]("hidden"),this.more.classList[r>s+i?"remove":"add"]("hidden"),0===s&&(this.results.innerHTML=""),t.forEach((e=>this.addVideo(e))),this.queryUrl=new URLSearchParams(this.query).toString(),window.history.pushState("","","/search/?"+this.queryUrl),this.offset=s+i,this.wait=!1}async submit(e){e.preventDefault();const t=Object.fromEntries(new FormData(this.form));this.wait||JSON.stringify(t)===JSON.stringify(this.query)||(this.query=t,await this.search())}}document.addEventListener("DOMContentLoaded",(()=>new VideoSearch));